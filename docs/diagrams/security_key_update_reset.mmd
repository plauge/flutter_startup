flowchart TD
    Desc["ðŸ”‘ Opdater eller nulstil security key\nNÃ¥r brugeren mangler key'en (ny telefon) eller har glemt den,\nkan de opdatere (indtaste nuvÃ¦rende) eller nulstille (generer ny).\nBegge flows slutter med at key'en er gyldig og brugeren\nkan tilgÃ¥ PIN-beskyttede sider igen."]
    style Desc fill:#e8f4fd,stroke:#b8d4e8

    subgraph Update ["Opdater â€” bruger kender sin nuvÃ¦rende key"]
        UpdateStart["Bruger indtaster sin key\nog trykker Opdater"]
        ValidateForm["Tjek at feltet er\nkorrekt udfyldt"]
        UpdateStart --> ValidateForm
        VerifyDecrypt["Verificer at key'en er rigtig:\nDekryptÃ©r check-vÃ¦rdien fra skyen\nmed den indtastede key"]
        ValidateForm --> VerifyDecrypt
        VerifyDecrypt -->|"Matcher â€” key er korrekt"| SaveStorage["Gem den verificerede key\ni telefonens secure storage"]
        VerifyDecrypt -->|"Matcher ikke"| ShowError["Vis fejlbesked:\nKey'en er forkert"]
        SaveStorage --> MarkValidated["MarkÃ©r bruger som valideret\n(spring fremtidige tjek over i denne session)"]
        MarkValidated --> NavBack["GÃ¥ tilbage eller til start"]
    end

    subgraph Reset ["Nulstil â€” bruger har glemt key'en"]
        ResetStart["Bruger bekrÃ¦fter i dialog\nat de vil nulstille"]
        ResetStart --> CallRPC
        CallRPC["Kald Supabase: Slet gammel key\nfra databasen og user_extra"]
        CallRPC -->|"Succes"| GenToken["Generer helt ny key\ngem lokalt + krypteret i skyen"]
        GenToken --> MarkValidatedReset["MarkÃ©r bruger som valideret"]
        MarkValidatedReset --> NavHome["GÃ¥ til start"]
    end
