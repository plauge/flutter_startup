flowchart TD
    Desc["ðŸšª RÃ¦kkefÃ¸lge af tjek â€” hvad afgÃ¸res fÃ¸r en side vises?\nAlle autentificerede sider gennemgÃ¥r disse tjek i rÃ¦kkefÃ¸lge.\nHvert tjek kan sende brugeren vÃ¦k til en anden side.\nKun hvis alle tjek bestÃ¥s, vises sidens indhold."]
    style Desc fill:#e8f4fd,stroke:#b8d4e8

    Build["Bruger forsÃ¸ger at\nÃ¥bne en side"] --> AuthCheck["1. Er brugeren logget ind?\n(Tjek Supabase auth session)"]
    AuthCheck -->|"Nej"| AuthResult["Send til login\neller splash"]
    AuthCheck -->|"Ja"| TermsCheck["2. Har brugeren accepteret\ngransningsbetingelser?\n(Tjek userExtra.termsConfirmed)"]
    TermsCheck -->|"Nej"| RedirectTerms["Send til\nTerms of Service"]
    TermsCheck -->|"Ja"| OnboardingCheck["3. Er dette en side der\nkrÃ¦ver fÃ¦rdiggjort onboarding?\n(Fx Kontakter, Home, Connect)"]
    OnboardingCheck -->|"Ja â€” fx Kontakter"| UserExtraWatch["Hent brugerens profil\nfra Supabase"]
    OnboardingCheck -->|"Nej â€” fx Indstillinger"| MasterKeyPath
    UserExtraWatch -->|"Data hentet"| OnboardingData["4a. Har brugeren gennemfÃ¸rt\nonboarding-flowet?"]
    OnboardingData -->|"Nej"| RedirectOnboarding["Send til\nonboarding-start"]
    OnboardingData -->|"Ja"| MasterKeyPath
    MasterKeyPath{"4b. Er siden PIN-beskyttet\nog er vi IKKE pÃ¥\nkey-opsÃ¦tningssiden?"}
    MasterKeyPath -->|"Ja"| MasterKeyWatch["Tjek om bruger har\nen gyldig security key\n(se master_key_validation)"]
    MasterKeyPath -->|"Nej"| FaceID
    MasterKeyWatch -->|"Key OK"| FaceID["5. KrÃ¦ver siden Face ID?\nHvis ja: vis Face ID prompt"]
    MasterKeyWatch -->|"Key mangler/forkert"| RedirectUpdateKey["Send til\nopdater security key"]
    FaceID --> Content["âœ… Vis sidens indhold"]
